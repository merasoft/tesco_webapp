<p-drawer [(visible)]="filtersOpen" [blockScroll]="true" [fullScreen]="true" styleClass="filter-drawer" (onShow)="onMobileFilterOpen()" (onHide)="onMobileFilterCancel()">
  <ng-template #header>
    <h3 class="text-lg font-semibold text-gray-900">Фильтры</h3>
  </ng-template>

  <ng-template #content>
    <div class="overflow-y-auto">
      <p-accordion [(value)]="accordionActiveValues" [multiple]="true" class="filter-accordion" expandIcon="pi pi-chevron-down" collapseIcon="pi pi-chevron-up">
        <!-- Price Filter -->
        <p-accordion-panel value="price" class="mb-4">
          <p-accordion-header>
            <span class="text-sm font-semibold text-gray-900">Цена</span>
          </p-accordion-header>
          <p-accordion-content>
            <div class="space-y-4 px-2 py-4">
              <!-- Price Inputs -->
              <div class="grid grid-cols-2 gap-3" *ngIf="tempFilters.length > 0">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">От</label>
                  <p-inputnumber
                    [(ngModel)]="tempFilters[0].currentMin"
                    (ngModelChange)="onTempPriceRangeChange($event)"
                    [useGrouping]="true"
                    [showButtons]="false"
                    placeholder="0"
                    [style]="{ width: '100%' }"
                    inputStyleClass="text-sm">
                  </p-inputnumber>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">До</label>
                  <p-inputnumber
                    [(ngModel)]="tempFilters[0].currentMax"
                    (ngModelChange)="onTempPriceRangeChange($event)"
                    [useGrouping]="true"
                    [showButtons]="false"
                    placeholder="∞"
                    [style]="{ width: '100%' }"
                    inputStyleClass="text-sm">
                  </p-inputnumber>
                </div>
              </div>

              <!-- Price Range Slider -->
              <div class="p-2" *ngIf="tempFilters.length > 0">
                <p-slider [(ngModel)]="tempFilters[0].range" [range]="true" [min]="tempFilters[0].min" [max]="tempFilters[0].max" (onSlideEnd)="onTempPriceRangeChange($event)" />
              </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

        <!-- Categories Filter (only show if subcategories exist) -->
        <p-accordion-panel value="categories" class="mb-4" *ngIf="shouldShowCategories">
          <p-accordion-header>
            <span class="text-sm font-semibold text-gray-900">Категории</span>
          </p-accordion-header>
          <p-accordion-content>
            <div class="pt-4">
              <div class="space-y-1 pr-1 max-h-64 overflow-y-auto filter-options">
                <div *ngFor="let category of subcategories" class="filter-option" (click)="onCategoryClick(category)">
                  <div class="flex items-center justify-between w-full cursor-pointer">
                    <span class="text-gray-700 text-sm">{{ category.name }}</span>
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full" *ngIf="category.count">
                        {{ category.count }}
                      </span>
                      <i class="pi pi-chevron-right text-xs text-gray-400"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

        <!-- Dynamic Filter Panels -->
        <p-accordion-panel *ngFor="let filter of tempFilters.slice(1); let i = index" [value]="filter.id" class="group">
          <p-accordion-header>
            <div class="flex items-center justify-between w-full">
              <div class="flex items-center gap-3">
                <span class="text-sm font-semibold text-gray-900">{{ filter.name }}</span>
                <div *ngIf="getTempFilterCheckedCount(filter) > 0" class="w-5 h-5 pr-0.5 flex items-center justify-center bg-blue-100 text-blue-800 rounded text-xs font-medium">
                  {{ getTempFilterCheckedCount(filter) }}
                </div>
              </div>
            </div>
          </p-accordion-header>

          <p-accordion-content class="mb-4 group-last:mb-0">
            <div class="pt-4">
              <div class="space-y-1 pr-1 max-h-64 overflow-y-auto filter-options">
                <div *ngFor="let option of filter.options" class="filter-option" [ngClass]="{ 'bg-blue-50': option.checked }" (click)="onTempFilterOptionChange(filter, option)">
                  <p-checkbox [inputId]="'temp_' + filter.id + '_' + option.id" [(ngModel)]="option.checked" [binary]="true" />

                  <label [for]="'temp_' + filter.id + '_' + option.id" class="ml-3 text-sm cursor-pointer flex-1 flex items-center justify-between select-none" (click)="$event.preventDefault()">
                    <span class="text-gray-700" [ngClass]="{ 'rating-stars': filter.id === 'rating' }" [innerHTML]="option.name"></span>
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full" [ngClass]="{ 'bg-blue-200': option.checked, 'text-gray-900': option.checked }">
                      {{ option.count }}
                    </span>
                  </label>
                </div>
              </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>
      </p-accordion>

      <div class="flex items-center justify-end gap-3 pt-4 mt-4 border-t border-t-gray-200">
        <button type="button" class="px-4 py-2 text-sm rounded-md border border-gray-200" (click)="onMobileFilterCancel()"> Отмена </button>
        <button type="button" class="px-4 py-2 text-sm rounded-md bg-blue-600 text-white" (click)="onMobileFilterApply()"> Применить </button>
      </div>
    </div>
  </ng-template>
</p-drawer>
